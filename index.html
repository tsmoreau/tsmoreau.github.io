<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <title>MetaMask Login Demo</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>

    <style>
        html, body {
            width: 100%;
            height: 100%;
        }

        .container {
            width: 100%;
            height: 100%;

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .label {
            margin-top: 30px;
            margin-bottom: 10px;
        }

        .input-group {
            margin-bottom: 10px;
            max-width: 1000px;
        }
    </style>

</head>
<body>

    <div class="container">

        <button class="btn btn-primary" onclick="buttonClicked()">Login</button>

        <h5 class="label">Result from web3 API</h5>

        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">Public Address</span>
            </div>
            <input id="text-address" type="text" class="form-control" disabled>
        </div>

        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">Nonce</span>
            </div>
            <input id="text-nonce" type="text" class="form-control" disabled>
        </div>

        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">Signature</span>
            </div>
            <input id="text-signature" type="text" class="form-control" disabled>
        </div>

        <h5 class="label">Result from backend server</h5>

        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">JWT</span>
            </div>
            <input id="text-token" type="text" class="form-control" disabled>
        </div>

    </div>

    <script>
        var web3;

        function createNonce() {

            var dict = "abcdefghijklmnopqrstuvwxyz0123456789".split("");
            var result = "";

            for(var i = 0; i < 10; i++) {
                var rand = Math.floor(Math.random() * 36);
                result += dict[rand];
            }

            return result;

        }

        function getAddress() {
            return new Promise(function(resolve, reject) {

                web3 = new Web3(window.ethereum);

                web3.eth.getCoinbase(function(error, coinbase) {

                    if(!coinbase) window.alert('MetaMask not activated!');

                    var publicAddress = coinbase.toLowerCase();
                    resolve(publicAddress);

                });

            });
        }

        function getSignature(publicAddress) {
            return new Promise(function(resolve, reject) {

                var data = createNonce();

                web3.eth.personal.sign(
                    data,
                    publicAddress,
                    '', // password is ignored by metamask
                    function(error, signature) {

                        var result = {
                            address: publicAddress,
                            nonce: data,
                            signature: signature
                        };

                        resolve(result);

                    }
                );

            });
        }

        function showWeb3Result(result) {

            document.getElementById('text-address').value = result.address;
            document.getElementById('text-nonce').value = result.nonce;
            document.getElementById('text-signature').value = result.signature;

            return result;

        }

        function getToken(result) {
            return new Promise(function(resolve, reject) {

                axios.post('/api/auth', {
                    'publicAddress': result.address,
                    'nonce': result.nonce,
                    'signature': result.signature
                }).then(function(response) { resolve(response.data.token); })

            });
        }

        function showBackendResult(token) {

            document.getElementById('text-token').value = token;

        }

        function buttonClicked() {

            window.ethereum.enable()
                .then(getAddress)
                .then(getSignature)
                .then(showWeb3Result)
                .then(getToken)
                .then(showBackendResult);

        }
    </script>
  
  
   <h3> Tell me a secret! <!-- ADD A SUBHEADING --></h3>

  <div>
    <button id="getSecretWord">Tell me a secret!</button><h3><span style="font-weight: bold;" id="secretWordOutput"></span></h3>
  </div>

  <br> <br>

  <div>
    <h3> New Secret <!-- ADD A SUBHEADING --></h3>
    <input id="newSecretWord" type="text" name="newSecretWord">
    <button id="setSecretWord">Set!</button><h3><span id="setBtnResponse"></span></h3>
  </div>

  <br>

  <span class="hint"><strong>Hint:</strong> Open the browser developer console to view any errors and warnings. Changes in the local file will automatically show up here. If not, double check your code. </span>

  <script src="javascript/web3.min.js"></script>
  <script src="app.js"></script>
  
  
  
  <div class="container">
      <div class="row">
        <div class="col-md-12">
          <h1>Web3modal example for vanille JavaScript and HTML</h1>

          <p>No wallet connected. Connect wallet to show accounts and their ETH balances.</p>

          <div class="alert alert-danger" id="alert-error-https" style="display: none">
            You can run this example only over HTTPS connection.
          </div>

          <div id="prepare">
            <button class="btn btn-primary" id="btn-connect">
              Connect wallet
            </button>
          </div>

          <div id="connected" style="display: none">

            <button class="btn btn-primary" id="btn-disconnect">
              Disconnect wallet
            </button>

            <hr>

            <div id="network">
              <p>
                <strong>Connected blockchain:</strong> <span id="network-name"></span>
              </p>

              <p>
                <strong>Selected account:</strong> <span id="selected-account"></span>
              </p>

            </div>

            <hr>

            <h3>All account balances</h3>

            <table class="table table-listing">
              <thead>
                <th>Address</th>
                <th>ETH balance</th>
              </thead>

              <tbody id="accounts">
              </tbody>
            </table>

            <p>Please try to switch between different accounts in your wallet if your wallet supports this functonality.</p>

          </div>

          <br>

          <div class="well">
            <p class="text-muted">See also the <a href="https://web3modal.com/">TypeScript and React example application</a></p>
          </div>

        </div>
      </div>
    </div>

    <!-- We use simple <template> templating for the example -->
    <div id="templates" style="display: none">
      <template id="template-balance">
        <tr>
          <th class="address"></th>
          <td class="balance"></td>
        </tr>
      </template>
    </div>

    <!--
      Use unpkg CDN to load all NPM packages to vanilla Javascript - read more at http://unpkg.com
      On your deployment, you properly either want to use a preprocessing tool like webpack
      to include these files, or extract NPM archives and manually host the files inside.
      TODO: Pin down all versions.
    -->

    <script type="text/javascript" src="https://unpkg.com/web3@1.2.11/dist/web3.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
    <script type="text/javascript" src="https://unpkg.com/evm-chains@0.2.0/dist/umd/index.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@walletconnect/web3-provider@1.2.1/dist/umd/index.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/fortmatic@2.0.6/dist/fortmatic.js"></script>

    <!-- This is our example code -->
    <script type="text/javascript" src="./app.js"></script>

</body>
</html>
